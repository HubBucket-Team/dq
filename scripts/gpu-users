#!shell -p

h=$(hostname -s)
lsof -n /dev/nvidia? 2>/dev/null | sed -r -e 's/[ \t]+/ /g' | grep "mem CHR" | sed 's,/dev/,,' | while read line; do
     set $line
     if [ $4 != "mem" ] ; then
          continue;
     fi
     file=$8
     inode=$7
     proc=$1
     pid=$2
     user=$3
     num=$(echo $file | sed 's/[^0-9]//g')
     mem=$(nvidia-smi -i $num | grep -i 'MiB /' | sed -r 's,.*[^0-9]([0-9]+)MiB /.*,\1,')
     status=$(sed -n 's/State:[ \t]*//p' /proc/$pid/status)
     echo "[GPU-$num $mem-MB] User: $user Process: $proc $pid $status"
done
