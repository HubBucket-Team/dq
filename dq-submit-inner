#!/bin/bash

D=$(cd `dirname $0` && pwd)
cd $CPWD

NESTEDLOCK=/dev/null
if [ "x$CUDA_VISIBLE_DEVICES" != "x" ]; then
    NESTEDLOCK=/dev/nvidia$CUDA_VISIBLE_DEVICES
fi

touch $D/jobs/active/$JOBID/lock
flock -x $D/jobs/active/$JOBID/lock flock -x $NESTEDLOCK $D/jobs/active/$JOBID/runme.sh
sleep 10
mv $D/jobs/active/$JOBID $D/jobs/complete
