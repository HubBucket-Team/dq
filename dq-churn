#!/bin/bash

CLUSTER_START=${DQ_CLUSTER_START:-1}
CLUSTER_CNT=${DQ_CLUSTER_CNT:-24}
# not specifying array due to http://stackoverflow.com/questions/5564418/exporting-an-array-in-bash-script
EXCLUDE_START=${DQ_EXCLUDE_START:-25}
EXCLUDE_END=${DQ_EXCLUDE_END:-26}
CLUSTER_EXCLUDE=$(for i in `seq $EXCLUDE_START $EXCLUDE_END`; do echo $i; done)
GPU_CNT=4

CLUSTER=$(hostname -s | sed 's/[0-9]//g')
D=$(cd `dirname $0` && pwd)
SSH="ssh -q -x -o BatchMode=yes" #" -o ConnectTimeout=10 -o ServerAliveInterval=3"

QDIR=$D/jobs/queue
mkdir -p $QDIR && touch $QDIR
touch $QDIR/.lock
(
    echo -n "Locking..."
    flock -xw 10 200 || {
	echo " Timeout!"
	echo "Please inspect system with 'dq-status' 'dq-free' etc."
	exit 1
    }

    echo " locked."

    JOBS=`ls -1 $QDIR | fgrep - | sort -n -k1 -t-`

    if [ "x$JOBS" = "x" ]; then
	echo "No job requests to schedule"
	exit 0
    fi

    for JOBID in $JOBS; do
	export KRB5CCNAME=$QDIR/$JOBID/ticket.krb5
	export USER=$(cat $QDIR/$JOBID/user.txt)

	ALL_FREE=$($D/dq-on-all gpu-free-list)
	HOST=
	GPU=
	for i in `seq $CLUSTER_START $CLUSTER_CNT | tac`; do
        skip=false;
        for j in ${CLUSTER_EXCLUDE[@]}; do
            if [[ "$i" -eq "$j" ]] ; then
                skip=true;
            fi;
        done;
        if $skip; then
            continue;
        fi
	    for gpu in `seq 0 $GPU_CNT`; do
		if [[ "$ALL_FREE" == *"$CLUSTER$i: GPU-$gpu"* ]]; then
		    HOST=$CLUSTER$i
		    GPU=$gpu
		    break
		fi
	    done
	    if [ "x$HOST" != "x" ]; then break; fi
	done


	if [ "x$HOST" == "x" ]; then
	    echo "Could not schedule $JOBID. (verify hosts with 'dq-free', 'dq-status' etc.')"
	    exit 1
	fi

	U=$(cat $QDIR/$JOBID/user.txt)
	echo "Executing '$JOBID' on $HOST/$GPU as $USER..."
	$SSH $USER@$HOST CUDA_VISIBLE_DEVICES=$GPU $D/dq-submit-backend $JOBID
    done

) 200>$QDIR/.lock
